
<!-- This is a common initialization file for JacORB     -->
<!--                                                     -->
<!-- This should not be called directly; instead it      -->
<!-- should be included with '&common;' syntax.          -->

<target name="base-init" unless="BASE-INIT">
    <property name="dirs.base" value="${basedir}"/>
    <property name="src" value="${dirs.base}/src"/>
    <property name="lib" value="${dirs.base}/lib"/>
    <property name="idl" value="${dirs.base}/idl"/>
</target>


<!-- Call base-init first. The regression tests call this but -->
<!-- have their own base-init                                 -->
<target name="init" depends="base-init,ant-version">
    <property name="debug" value="off"/>
    <!-- This value only used under Ant 1.5 -->
    <property name="debuglevel" value="lines,source"/>

    <property name="architecture" value="unix"/>
    <condition property="architecture" value="windows">
       <or>
          <os family="windows"/>
          <os family="dos"/>
       </or>
    </condition>
    <!-- Location of the compiled classes -->
    <pathconvert property="classdir" targetos="${architecture}">
       <path>
          <pathelement location="${dirs.base}/classes"/>
       </path>
    </pathconvert>

    <!-- The 'classpath' property is used as the run time for some tests -->
    <pathconvert property="classpath" targetos="${architecture}">
       <path>
          <pathelement location="${dirs.base}/classes"/>
          <pathelement location="${basedir}/classes"/>
          <pathelement location="${lib}/logkit.jar"/>
          <pathelement location="${lib}/concurrent.jar"/>
          <pathelement location="${lib}/antlr.jar"/>

          <pathelement location="${java.class.path}"/>
       </path>
    </pathconvert>

    <!-- The 'xbootclasspath' value used in compilation -->
    <pathconvert property="xbootclasspath" targetos="${architecture}">
       <path>
          <pathelement location="${dirs.base}/classes"/>
          <pathelement location="${basedir}/classes"/>
          <pathelement location="${sun.boot.class.path}"/>
          <pathelement location="${lib}/logkit.jar"/>
          <pathelement location="${lib}/concurrent.jar"/>
          <pathelement location="${lib}/antlr.jar"/>

          <pathelement location="${java.class.path}"/>
       </path>
    </pathconvert>

    <mkdir dir="${classdir}"/>
    <mkdir dir="${src}/generated"/>
    <filter token="path" value="basedir"/>
</target>

<target name="whats-my-classpath" depends="init" description="Outputs the classpath that will be used for compilation of the JacORB">
         <echo message="JacORB will be built with the following (boot) classpath:${line.separator}${xbootclasspath}"/>
</target>

<target name="load-taskdef">
   <taskdef name="jacidl" classname="org.jacorb.idl.JacIDL" classpath="${basedir}/classes:${basedir}/lib/logkit.jar"/>
</target>

<target name="ant-version" unless="ant15">
    <available classname="org.apache.tools.ant.filters.ClassConstants" property="ant15"/>
</target>


<target name="check-src" unless="javac-src">
   <property name="javac-src" value="${src}"/>
</target>


<target name="check-excludes" unless="javac-excludes">
   <property name="javac-excludes" value=""/>
</target>


<target name="check-includes" unless="javac-includes">
   <fail message="Pass javac-includes to target"/>
</target>

<target name="check-sourcepath" unless="javac-sourcepath">
  <property name="javac-sourcepath" value="" />
</target>


<!-- This target is a compatibility wrapper to allow either a Ant 14 or Ant  -->
<!-- 15 to be used. Optional parameters are:                                 -->
<!-- javac-src        Defaults to ${src}                                     -->
<!-- javac-excludes   For file selection; defaults to '' -->
<!-- javac-sourcpath  Compile Option Sourcepath; defaults to '' -->
<!-- Mandatory parameter is:                                                 -->
<!-- javac-includes   Specifies which files to compile.                      -->
<target name="jacorb-javac" depends="check-includes, check-sourcepath,javac-14,javac-15"/>


<!-- Note use of bootclasspath is to override ORB classes in rt.jar. Ant     -->
<!-- doesn't allow prepend so must add in rt.jar as well                     -->
<target name="javac-14" depends="check-src,check-excludes" unless="ant15">
   <echo message="Compiling for ${ant.project.name}"/>
   <javac srcdir="${javac-src}"
          destdir="${classdir}"
          bootclasspath="${xbootclasspath}"
          debug="${debug}"
          includes="${javac-includes}"
          excludes="${javac-excludes}">
     <src path="${javac-sourcepath}" />
   </javac>
</target>


<target name="javac-15" depends="check-src,check-excludes" if="ant15">
   <echo message="Compiling for ${ant.project.name}"/>
   <javac srcdir="${javac-src}"
          destdir="${classdir}"
          bootclasspath="${xbootclasspath}"
          debug="${debug}"
          debuglevel="${debuglevel}"
          sourcepath="${javac-sourcepath}"
          includes="${javac-includes}"
          excludes="${javac-excludes}">
   </javac> 
</target>
