<?xml version="1.0"?>

<project name="test" default="run-all" basedir="../..">


  <!-- ==================================================== -->
  <!--             JacORB Tests build file                  -->
  <!-- ==================================================== -->


   <target name="init">
      <property name="testdir" value="${basedir}/test/regression"/>
      <property name="dirs.src" value="${testdir}/src"/>
      <property name="dirs.idl" value="${testdir}/idl"/>
      <property name="dirs.classes" value="${basedir}/classes"/>
      <property name="dirs.output" value="${testdir}/output"/>
      <property name="idl.flags" 
                value="-p org.jacorb -d ${dirs.src}/generated"/>
      <property name="class.path" value="${java.class.path}:${dirs.classes}"/>
   </target>


   <!-- ==================================================== -->
   <!--             compile and run tests                    -->
   <!-- ==================================================== -->


   <target name="build-all" depends="init">
      <echo message="${class.path}"/>
      <antcall target="compile-idl"/>
      <antcall target="compile-src"/>
   </target>


   <target name="compile-src">
      <javac srcdir="${dirs.src}" 
             destdir="${dirs.classes}"
             excludes="generated/**"
             classpath="${class.path}"/>
   </target>


   <target name="run" depends="build-all">
      <junit fork="yes" printsummary="on">
         <jvmarg value="-Xbootclasspath/p:${class.path}"/>
         <formatter type="plain"/>
	      <test name="${test}" todir="${dirs.output}"/>
      </junit>
   </target>


   <!-- ==================================================== -->
   <!--                  compile idl                         -->
   <!-- ==================================================== -->


   <target name="compile-idl">
      <antcall target="idl-tests"/>
   </target>


   <target name="process-idl">
      <condition property="${props.idl}">
         <or>
            <not>
               <available file="${dirs.classes}/${pkg.idl}"/>
            </not>
            <uptodate targetfile="${dirs.idl}/${file.idl}">
               <srcfiles dir="${dirs.src}/generated/${pkg.idl}" 
                         includes="**/*.java"/>
            </uptodate>
         </or>
      </condition>
      <antcall target="generate-src"/>
   </target>


   <target name="generate-src"  if="${props.idl}">
      <java classname="org.jacorb.idl.parser"
            classpath="${class.path}">
	      <arg line="${idl.flags} ${dirs.idl}/${file.idl}"/>
      </java>
      <javac srcdir="${dirs.src}/generated"
             destdir="${dirs.classes}"
             includes="${pkg.idl}/**"
             classpath="${class.path}"/>
   </target>


   <!-- ==================================================== -->
   <!--                compile Tests.idl                     -->
   <!-- ==================================================== -->


   <target name="idl-tests">
      <property name="props.idl" value="Tests"/>
      <property name="pkg.idl" value="org/jacorb/Tests"/>
      <property name="file.idl" value="Tests.idl"/>
      <antcall target="process-idl"/>
  </target>


   <!-- ==================================================== -->
   <!--                  run all tests                       -->
   <!-- ==================================================== -->


   <target name="run-all"
           description="Run all Jacorb tests">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.AllTest"/>
      </antcall>
   </target>


   <target name="run-all-separate"
           description="Run all Jacorb tests, logging results in separate files">
      <antcall target="run-all-orb-separate"/>
   </target>


   <!-- ==================================================== -->
   <!--                  run orb tests                       -->
   <!-- ==================================================== -->


   <target name="run-all-orb"
           description="Run all Jacorb tests in the orb package and its subpackages">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.AllTest"/>
      </antcall>
   </target>


   <target name="run-all-orb-separate"
           description="Run all Jacorb tests in the orb package and its subpackages, logging results in separate files">
      <antcall target="run-all-dynany-separate"/>
   </target>


   <!-- ==================================================== -->
   <!--                 run dynany tests                     -->
   <!-- ==================================================== -->


   <target name="run-all-dynany"
           description="Run all Jacorb tests in the dynany package and its subpackages">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.AllTest"/>
      </antcall>
   </target>


   <target name="run-all-dynany-separate"
           description="Run all Jacorb tests in the dynany package and its subpackages, logging results in separate files">
      <antcall target="run-package-dynany-separate"/>
   </target>


   <target name="run-package-dynany"
           description="Run all Jacorb tests in the dynany package only">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.PackageTest"/>
      </antcall>
   </target>


   <target name="run-package-dynany-separate"
           description="Run all Jacorb tests in the dynany package only, logging results in separate files">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyArrayTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyBaseTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyBoundedSeqTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyEmptyExTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyEnumTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyFixedTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyNonEmptyExTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyStructTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnboundedSeqTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnionIntTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnionTest"/>
      </antcall>
   </target>


   <!-- ==================================================== -->
   <!--                   clean up                           -->
   <!-- ==================================================== -->


   <target name="clean" 
           depends="init"
           description="Remove all generated source files and class files">
      <delete dir="${dirs.classes}/org" failonerror="false"/>
      <delete dir="${dirs.src}/generated/org" failonerror="false"/>
   </target>


</project>
