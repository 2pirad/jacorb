<?xml version="1.0"?>

<!DOCTYPE project [ <!ENTITY common SYSTEM "file:../../common.xml"> ]>

<project name="regression-test" default="help" basedir="../../">


  <!-- ==================================================== -->
  <!--             JacORB Tests build file                  -->
  <!-- ==================================================== -->
   <target name="help">
      <exec executable="java" outputproperty="OUTPUT">
         <arg line="-classpath ${java.class.path} org.apache.tools.ant.Main -logger org.apache.tools.ant.NoBannerLogger -projecthelp -buildfile ${basedir}/test/regression/build.xml"/>
      </exec>
      <echo message="${OUTPUT}"/>
   </target>

   &common;

   <!-- Using test-init so we can set different src, class and idl directories -->
   <target name="test-init" depends="ant-version,load-taskdef">
      <property name="debug" value="on"/>
      <!-- This value only used under Ant 1.5 -->
      <property name="debuglevel" value="lines,source"/>
      <property name="testdir" value="${basedir}/test/regression"/>
      <property name="src" value="${testdir}/src"/>
      <property name="idl" value="${testdir}/idl"/>
      <property name="dirs.output" value="${testdir}/output"/>
      <!-- Add JacORB classes -->
      <property name="classdir" value="${basedir}/test/regression/classes"/>
      <property name="classpath" value="${classdir}:${basedir}/classes:${java.class.path}"/>

      <mkdir dir="${src}/generated"/>
      <mkdir dir="${dirs.output}"/>
      <mkdir dir="${classdir}"/>
   </target>


   <!-- ==================================================== -->
   <!--             compile and run tests                    -->
   <!-- ==================================================== -->


   <target name="build-all" depends="test-init">
      <antcall target="compile-idl"/>
      <antcall target="compile-src"/>
   </target>


   <target name="compile-src">
      <antcall target="jacorb-javac">
         <param name="javac-includes" value="**"/>
         <param name="javac-excludes" value="generated/**"/>
      </antcall>
   </target>


   <target name="run" depends="build-all">
      <junit fork="yes" printsummary="withOutAndErr" showoutput="true">
         <jvmarg value="-Xbootclasspath/p:${classpath}"/>
         <jvmarg value="-Dtestdir=${testdir}"/>
         <formatter type="plain"/>
         <test name="${test}" todir="${dirs.output}"/>
      </junit>
   </target>


   <!-- ==================================================== -->
   <!--                  compile idl                         -->
   <!-- ==================================================== -->


   <target name="compile-idl">
      <antcall target="idl-tests"/>
   </target>


   <target name="process-idl">
      <condition property="${props.idl}">
         <or>
            <not>
               <available file="${classdir}/${pkg.idl}"/>
            </not>
            <not>
               <available file="${src}/generated/${pkg.idl}"/>
            </not>
            <uptodate targetfile="${idl}/${file.idl}">
               <srcfiles dir="${src}/generated/${pkg.idl}"
                         includes="**/*.java"/>
            </uptodate>
         </or>
      </condition>
      <antcall target="generate-src"/>
   </target>


   <target name="generate-src" if="${props.idl}">
      <jacidl generateir="true"
              srcdir="${idl}"
              packageprefix="org.jacorb"
              destdir="${src}/generated"
              includes="${file.idl}"/>
      <antcall target="jacorb-javac">
         <param name="javac-src" value="${src}/generated"/>
         <param name="javac-includes" value="${pkg.idl}/**"/>
      </antcall>
   </target>


   <!-- ==================================================== -->
   <!--                compile Tests.idl                     -->
   <!-- ==================================================== -->


   <target name="idl-tests">
      <property name="props.idl" value="Tests"/>
      <property name="pkg.idl" value="org/jacorb/Tests"/>
      <property name="file.idl" value="Tests.idl"/>
      <antcall target="process-idl"/>
  </target>


   <!-- ==================================================== -->
   <!--                  run all tests                       -->
   <!-- ==================================================== -->


   <target name="run-all"
           description="Run all Jacorb tests">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.AllTest"/>
      </antcall>
      <antcall target="compile-idl-test-generated"/>
  </target>


   <target name="run-all-separate"
           description="Run all Jacorb tests, logging results in separate files">
      <antcall target="run-all-orb-separate"/>
   </target>


   <!-- ==================================================== -->
   <!--                  run idl tests                       -->
   <!-- ==================================================== -->

   <target name="run-all-idl"
           description="Run all Jacorb tests in the idl package and its subpackages">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.idl.AllTest"/>
      </antcall>
      <antcall target="compile-idl-test-generated"/>
   </target>

   <target name="compile-idl-test-generated" depends="test-init">
       <!-- Compile the test idl -->
      <antcall target="jacorb-javac">
         <param name="javac-includes" value="generated/**"/>
      </antcall>
      <echo message="Successfully compiled test idl"/>
   </target>


   <!-- ==================================================== -->
   <!--                  run orb tests                       -->
   <!-- ==================================================== -->


   <target name="run-all-orb"
           description="Run all Jacorb tests in the orb package and its subpackages">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.AllTest"/>
      </antcall>
   </target>


   <target name="run-all-orb-separate"
           description="Run all Jacorb tests in the orb package and its subpackages, logging results in separate files">
      <antcall target="run-all-dynany-separate"/>
   </target>


   <!-- ==================================================== -->
   <!--                 run dynany tests                     -->
   <!-- ==================================================== -->


   <target name="run-all-dynany"
           description="Run all Jacorb tests in the dynany package and its subpackages">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.AllTest"/>
      </antcall>
   </target>


   <target name="run-all-dynany-separate"
           description="Run all Jacorb tests in the dynany package and its subpackages, logging results in separate files">
      <antcall target="run-package-dynany-separate"/>
   </target>


   <target name="run-package-dynany"
           description="Run all Jacorb tests in the dynany package only">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.PackageTest"/>
      </antcall>
   </target>


   <target name="run-package-dynany-separate"
           description="Run all Jacorb tests in the dynany package only, logging results in separate files">
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyArrayTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyBaseTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyBoundedSeqTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyEmptyExTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyEnumTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyFixedTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyNonEmptyExTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyStructTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnboundedSeqTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnionIntTest"/>
      </antcall>
      <antcall target="run">
         <param name="test" value="org.jacorb.test.orb.dynany.DynAnyUnionTest"/>
      </antcall>
   </target>


   <!-- ==================================================== -->
   <!--                   clean up                           -->
   <!-- ==================================================== -->


   <target name="clean"
           depends="test-init"
           description="Remove all generated source files and class files">
      <delete dir="${classdir}/org" failonerror="false"/>
      <delete dir="${src}/generated" failonerror="false"/>
      <delete dir="${classdir}" failonerror="false"/>
   </target>
</project>
